{
  "db_name": "PostgreSQL",
  "query": "\n            with\n            next_call as (\n                select c.id\n                from underway.activity_call c\n                where c.task_queue_name = $1\n                  and c.activity = any($2::text[])\n                  and (\n                    (\n                        c.state = 'pending'::underway.activity_call_state\n                        and c.available_at <= now()\n                    )\n                    or (\n                        c.state = 'in_progress'::underway.activity_call_state\n                        and c.lease_expires_at is not null\n                        and c.lease_expires_at <= now()\n                    )\n                  )\n                order by c.available_at, c.created_at, c.id\n                limit 1\n                for update skip locked\n            ),\n            claimed as (\n                update underway.activity_call c\n                set state = 'in_progress'::underway.activity_call_state,\n                    attempt_count = c.attempt_count + 1,\n                    updated_at = now(),\n                    started_at = now(),\n                    lease_expires_at =\n                        now() + ((c.timeout_ms::bigint + $3) * interval '1 millisecond')\n                from next_call\n                where c.id = next_call.id\n                returning\n                    c.id,\n                    c.task_queue_name,\n                    c.workflow_run_id,\n                    c.step_index,\n                    c.call_key,\n                    c.activity,\n                    c.input,\n                    c.attempt_count\n            ),\n            attempt as (\n                insert into underway.activity_call_attempt (\n                    activity_call_id,\n                    attempt_number,\n                    state\n                )\n                select\n                    claimed.id,\n                    claimed.attempt_count,\n                    'in_progress'::underway.activity_call_state\n                from claimed\n                on conflict (activity_call_id, attempt_number)\n                do update\n                  set state = 'in_progress'::underway.activity_call_state,\n                      error = null,\n                      started_at = now(),\n                      updated_at = now(),\n                      completed_at = null\n                returning\n                    activity_call_id,\n                    attempt_number\n            )\n            select\n                claimed.id,\n                claimed.task_queue_name,\n                claimed.workflow_run_id,\n                claimed.step_index,\n                claimed.call_key,\n                claimed.activity,\n                claimed.input,\n                claimed.attempt_count,\n                attempt.attempt_number\n            from claimed\n            inner join attempt\n              on attempt.activity_call_id = claimed.id\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "task_queue_name",
        "type_info": "Text"
      },
      {
        "ordinal": 2,
        "name": "workflow_run_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 3,
        "name": "step_index",
        "type_info": "Int4"
      },
      {
        "ordinal": 4,
        "name": "call_key",
        "type_info": "Text"
      },
      {
        "ordinal": 5,
        "name": "activity",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "input",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 7,
        "name": "attempt_count",
        "type_info": "Int4"
      },
      {
        "ordinal": 8,
        "name": "attempt_number",
        "type_info": "Int4"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        "TextArray",
        "Int8"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false
    ]
  },
  "hash": "cc62f99708c31ec3122d89da8efc79d41f8adc234de6470356eb0d2aca2efe75"
}
