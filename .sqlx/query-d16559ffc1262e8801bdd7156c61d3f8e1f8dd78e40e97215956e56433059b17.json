{
  "db_name": "PostgreSQL",
  "query": "\n            with stale_exhausted as (\n                select t.id\n                from underway.task t\n                where t.task_queue_name = $1\n                  and t.state = $2\n                  and t.last_heartbeat_at < now() - t.heartbeat\n                  and (t.retry_policy).max_attempts <= (\n                      select count(*)\n                      from underway.task_attempt ta\n                      where ta.task_queue_name = $1\n                        and ta.task_id = t.id\n                  )\n                for update skip locked\n            ),\n            finalized_attempts as (\n                update underway.task_attempt ta\n                set state = $3,\n                    updated_at = now(),\n                    completed_at = now(),\n                    error_message = coalesce(\n                        ta.error_message,\n                        'Task heartbeat became stale and retry policy was exhausted.'\n                    )\n                from stale_exhausted se\n                where ta.task_queue_name = $1\n                  and ta.task_id = se.id\n                  and ta.state = $2\n            )\n            update underway.task t\n            set state = $3,\n                updated_at = now(),\n                completed_at = now()\n            from stale_exhausted se\n            where t.task_queue_name = $1\n              and t.id = se.id\n            returning t.id as \"id: TaskId\"\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id: TaskId",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        {
          "Custom": {
            "name": "underway.task_state",
            "kind": {
              "Enum": [
                "pending",
                "in_progress",
                "waiting",
                "succeeded",
                "cancelled",
                "failed"
              ]
            }
          }
        },
        {
          "Custom": {
            "name": "underway.task_state",
            "kind": {
              "Enum": [
                "pending",
                "in_progress",
                "waiting",
                "succeeded",
                "cancelled",
                "failed"
              ]
            }
          }
        }
      ]
    },
    "nullable": [
      false
    ]
  },
  "hash": "d16559ffc1262e8801bdd7156c61d3f8e1f8dd78e40e97215956e56433059b17"
}
