{
  "db_name": "PostgreSQL",
  "query": "\n            with stale_exhausted as (\n                select t.id, t.current_attempt\n                from underway.task t\n                where t.task_queue_name = $1\n                  and t.state = $2\n                  and t.lease_expires_at is not null\n                  and t.lease_expires_at <= now()\n                  and t.attempt_count >= (t.retry_policy).max_attempts\n                for update skip locked\n            ),\n            finalized_attempts as (\n                update underway.task_attempt ta\n                set state = $3,\n                    updated_at = now(),\n                    completed_at = now(),\n                    error_message = coalesce(\n                        ta.error_message,\n                        'Task heartbeat became stale and retry policy was exhausted.'\n                    )\n                from stale_exhausted se\n                where ta.task_queue_name = $1\n                  and ta.task_id = se.id\n                  and ta.attempt_number = se.current_attempt\n                  and ta.state = $2\n            )\n            update underway.task t\n            set state = $3,\n                updated_at = now(),\n                completed_at = now(),\n                lease_expires_at = null\n            from stale_exhausted se\n            where t.task_queue_name = $1\n              and t.id = se.id\n            returning t.id as \"id: TaskId\"\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id: TaskId",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        {
          "Custom": {
            "name": "underway.task_state",
            "kind": {
              "Enum": [
                "pending",
                "in_progress",
                "waiting",
                "succeeded",
                "cancelled",
                "failed"
              ]
            }
          }
        },
        {
          "Custom": {
            "name": "underway.task_state",
            "kind": {
              "Enum": [
                "pending",
                "in_progress",
                "waiting",
                "succeeded",
                "cancelled",
                "failed"
              ]
            }
          }
        }
      ]
    },
    "nullable": [
      false
    ]
  },
  "hash": "5afed9f1570a85d784b5eea1011b1e629ec42e3e6f62246063b033e6e4eb78b6"
}
